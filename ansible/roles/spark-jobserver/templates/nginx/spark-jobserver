upstream spark-jobserver {
  server localhost:{{ spark_jobserver_port }};
}

server {
  listen 80 proxy_protocol;
  server_name ~^api-spark.*;
  rewrite ^ https://$host$request_uri? permanent;
}

server {
  listen 443 proxy_protocol;
  server_name ~^api-spark.*;

  real_ip_header proxy_protocol;
  set_real_ip_from 0.0.0.0/0;

  # Regular webserver support
  location / {
    proxy_pass http://spark-jobserver;
    proxy_set_header X-Real-IP       $proxy_protocol_addr;
    proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_redirect off;
  }
}
