upstream zeppelin {
  server localhost:{{ spark_zeppelin_port }};
}

server {
  listen 80 proxy_protocol;
  server_name ~^zeppelin.*;
  rewrite ^ https://$host$request_uri? permanent;
}

server {
  listen 443 proxy_protocol;
  server_name ~^zeppelin.*;

  real_ip_header proxy_protocol;
  set_real_ip_from 0.0.0.0/0;

  # Regular webserver support
  location / {
    proxy_pass http://zeppelin;
    proxy_set_header X-Real-IP       $proxy_protocol_addr;
    proxy_set_header X-Forwarded-For $proxy_protocol_addr;
    proxy_set_header Host $http_host;
    proxy_set_header X-NginX-Proxy true;
    proxy_redirect off;
  }

  # Websocket support
  location /ws {
    proxy_pass http://zeppelin;
    proxy_http_version 1.1;
    proxy_set_header Upgrade websocket;
    proxy_set_header Connection upgrade;
    proxy_read_timeout 86400;
    proxy_set_header X-Real-IP       $proxy_protocol_addr;
    proxy_set_header X-Forwarded-For $proxy_protocol_addr;
  }
}
